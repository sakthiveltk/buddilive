<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ca.digitalcave.buddi.live.db.Reports">
	<resultMap id="pie" type="ca.digitalcave.buddi.live.model.report.Pie">
		<id column="label" property="label"/>
		<result column="amount" property="amount"/>
	</resultMap>
	
	<resultMap id="summary" type="ca.digitalcave.buddi.live.model.report.Summary">
		<result column="actual" property="actual"/>
		<result column="budgeted" property="budgeted"/>
		<association property="source" resultMap="ca.digitalcave.buddi.live.model.Source"/>
	</resultMap>

	<select id="selectPieIncomeOrExpensesByCategory" resultMap="pie">
		SELECT 
			c.name AS label,
			sum(s.amount) AS amount
		FROM transactions t
		LEFT JOIN splits s ON s.transaction_id = t.id
		INNER JOIN sources c ON (c.id = s.from_source OR c.id = s.to_source) AND c.type = #{type}
		WHERE t.user_id = #{user.id}
			AND t.transaction_date >= #{startDate}
			AND t.transaction_date &lt;= #{endDate}
		GROUP BY c.name
		ORDER BY sum(s.amount) DESC
	</select>
	
	<select id="selectActualIncomeAndExpensesByCategory" resultMap="summary">
		SELECT 
			c.id s_id, c.name s_name, c.type s_type,
			
			sum(s.amount) AS amount
		FROM transactions t
		LEFT JOIN splits s ON s.transaction_id = t.id
		INNER JOIN sources c ON (c.id = s.from_source OR c.id = s.to_source)
		WHERE t.user_id = #{user.id}
			AND t.transaction_date >= #{startDate}
			AND t.transaction_date &lt;= #{endDate}
			AND (c.type = 'E' OR c.type = 'I')
		GROUP BY c.id, c.name, c.type
		ORDER BY c.type DESC, sum(s.amount) DESC
	</select>
</mapper>